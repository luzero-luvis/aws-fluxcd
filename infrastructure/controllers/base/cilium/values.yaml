# -----------------------------------------------------------------------------
# Cilium 1.18.2 - Kubeadm on AWS EC2 (cluster-pool mode)
# This configuration forces the generic operator and uses simple cluster-pool IPAM
# Recommended for kubeadm clusters that don't need deep AWS integration
# -----------------------------------------------------------------------------

# Kubernetes API server
k8sServiceHost: "10.0.100.116"       # Replace with your control plane host/IP
k8sServicePort: "6443"

# Routing / datapath
routingMode: "native"                # Direct routing between nodes
ipv4NativeRoutingCIDR: "10.244.0.0/16"  # Pod CIDR for native routing
autoDirectNodeRoutes: true
devices: "eth0"                      # Primary network interface on EC2

# Kube-proxy replacement
kubeProxyReplacement: true
kubeProxyReplacementHealthzBindAddr: "0.0.0.0:10256"

# IPAM - Using cluster-pool (NOT ENI)
ipam:
  mode: "cluster-pool"
  operator:
    clusterPoolIPv4PodCIDRList:
      - "10.244.0.0/16"

# NodePort / host load balancing
nodePort:
  enabled: true
  # Removed 'addresses: ["auto"]' - not supported in Cilium 1.18.2

# HostPort support (required if using Gateway API / Istio ingress)
hostPort:
  enabled: true

# BPF / TPROXY (required for Istio Gateway API)
bpf:
  masquerade: true
  tproxy: true
enableBPFTProxy: true

# Explicit masquerade settings
enableIPv4Masquerade: true
enableIPv6Masquerade: false

# CNI configuration
cni:
  exclusive: true

# Socket Load Balancer
socketLB:
  hostNamespaceOnly: true

# Network Policy
k8sNetworkPolicy:
  enabled: true

# Encryption
encryption:
  enabled: false       # Can enable WireGuard if needed

# Health checking
healthChecking: true

# Hubble observability
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - icmp
    enableOpenMetrics: true

# AWS ENI - DISABLED for kubeadm cluster-pool mode
eni:
  enabled: false

# Misc / tuning
forceDeviceDetection: true
directRoutingSkipUnreachable: false
policyEnforcementMode: default
bpfClockProbe: true
bpfLBAlgorithm: random

# CRITICAL: Force generic operator (not AWS variant)
# This prevents automatic AWS operator detection
operator:
  enabled: true
  replicas: 1
  image:
    override: "quay.io/cilium/operator-generic:v1.18.2"
    useDigest: false

# Gateway API support (requires CRDs to be installed first)
# Install with: kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.1/standard-install.yaml
gatewayAPI:
  enabled: true
envoy:
  enabled: true
