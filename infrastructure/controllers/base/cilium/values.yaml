# Cilium configuration for AWS EC2 (kubeadm + Istio Gateway API)

# API Server connectivity
k8sServiceHost: "10.0.100.116"
k8sServicePort: "6443"

# Use native routing in AWS
routingMode: "native"          # AWS supports direct routing between subnets
autoDirectNodeRoutes: true
devices: "eth0"                # Usually 'eth0' on AWS instances

# Kube-proxy replacement
kubeProxyReplacement: "strict"
kubeProxyReplacementHealthzBindAddr: "0.0.0.0:10256"

# IPAM configuration - use cluster-pool mode, matching your kubeadm Pod CIDR
ipam:
  mode: "cluster-pool"
  operator:
    clusterPoolIPv4PodCIDRList: ["10.244.0.0/16"]

# NodePort configuration - use AWS VPC CIDR range
nodePort:
  enabled: true
  addresses: ["auto"]          # Automatically detects primary VPC interface

# BPF and TPROXY settings for Istio
bpf:
  masquerade: true
  tproxy: true
enableBPFTProxy: true

# CNI configuration
cni:
  exclusive: true

# Socket load balancer - keeps traffic local to the host namespace
socketLB:
  hostNamespaceOnly: true

# Network policies
k8sNetworkPolicy:
  enabled: true

# Encryption
encryption:
  enabled: false                # Optional: AWS already isolates VPC traffic

# Health checking
healthChecking: true

# Hubble observability
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true

# AWS-specific options
# This ensures Cilium properly handles AWS ENIs
eni:
  enabled: true
  awsReleaseExcessIPs: true     # Frees unused IPs to prevent exhaustion
  updateEC2AdapterLimitViaAPI: true

